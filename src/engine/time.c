// ======================================================================================
// File         : time.c
// Author       : Wu Jie 
// Last Change  : 01/28/2011 | 13:39:26 PM | Friday,January
// Description  : 
// ======================================================================================

///////////////////////////////////////////////////////////////////////////////
// includes
///////////////////////////////////////////////////////////////////////////////

#include "exsdk.h"
#include "time.h"

///////////////////////////////////////////////////////////////////////////////
// private
///////////////////////////////////////////////////////////////////////////////

static uint32 __timer_engine_start = 0;
static uint32 __timer_world_loaded = 0;
static uint32 __timer_frame_start = 0;

static float __time = 0.0f;
static float __time_noscale = 0.0f;
static float __worldtime = 0.0f;
static float __dt = 0.0f;
static float __dt_noscale = 0.0f;
static float __dt_fixed = 1.0f;
static float __timescale = 1.0f;
static float __last_timescale = 1.0f;

static float __fps = 0.0f;
static uint32 __frame_count = 0;

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static int32 __calc_fps ( uint32 _interval, void *_param ) {
    float secs = (float)_interval/1000.0f;
    __fps = (float)__frame_count / secs;
    __frame_count = 0;
    return _interval;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void __start_engine_time () {
    int id; 
    uint32 now = ex_timer_get_ticks();

    __timer_engine_start = now; 
    __timer_frame_start = now;
    __time = (float)now/1000.0f;

    id = ex_add_timer ( ex_timespan_from(1,0),
                        __calc_fps, 
                        NULL, 
                        0 );
    ex_start_timer(id);
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void __world_time_start () {
    uint32 now = ex_timer_get_ticks();
    __timer_world_loaded = now;
    __worldtime = (float)now/1000.0f;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void __tick_engine_time () {
    uint32 now = ex_timer_get_ticks();

    ++__frame_count;
    __dt_noscale = (float)(now-__timer_frame_start)/1000.0f;
    __dt = __dt_noscale * __timescale;
    __time_noscale = (float)(now-__timer_engine_start)/1000.0f;
    __time += __dt;
    __worldtime += __dt;
    __timer_frame_start = now;
}

///////////////////////////////////////////////////////////////////////////////
// public defines
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_time () { return __time; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_time_noscale () { return __time_noscale; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_worldtime () { return __worldtime; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_realtime () { return (float)(ex_timer_get_ticks()-__timer_engine_start)/1000.0f; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_dt () { return __dt; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_dt_noscale () { return __dt_noscale; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_dt_fixed () { return __dt_fixed; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_timescale () { return __timescale; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_set_timescale ( float _scale ) { __timescale = _scale; }

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_pause () {
    if ( ex_is_zerof(__timescale,EX_FLOAT_EPS) ) {
        ex_warning("the engine already paused!");
        return;
    }
    __last_timescale = __timescale;
    __timescale = 0.0f;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_resume () {
    __timescale = __last_timescale;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

float ex_fps () { return __fps; }
uint32 ex_frames () { return __frame_count; }
