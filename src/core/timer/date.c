// ======================================================================================
// File         : date.c
// Author       : Wu Jie 
// Last Change  : 12/30/2010 | 20:21:29 PM | Thursday,December
// Description  : 
// ======================================================================================

///////////////////////////////////////////////////////////////////////////////
// includes
///////////////////////////////////////////////////////////////////////////////

#include "exsdk.h"

///////////////////////////////////////////////////////////////////////////////
// defines
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const char* __month_name[12] = {
    "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
};

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const char* __week_name[7] = {
    "Mon", "Tues", "Wed", "Thur", "Fri", "Sat", "Sun",
};

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const uint8 __month_days[12] = { 
    31,28,31,30,31,30,31,31,30,31,30,31 
};

///////////////////////////////////////////////////////////////////////////////
// function defines
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

const char* ex_week_day_name ( uint _wday ) {
    ex_assert_return ( _wday >= 1 && _wday <= 7, "invalid", "invalid weekday input" );
    return __week_name[_wday-1];
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

const char* ex_month_name ( uint _month ) {
    ex_assert_return ( _month >= 1 && _month <= 12, "invalid", "invalid month input" );
    return __month_name[_month];
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

bool ex_is_valid_date ( uint _year, uint _month, uint _day ) {
    if ( _month<1 || _month>12 || _day<1 || _day>31 )
        return false;
    return true;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

bool ex_is_leap_year ( uint _year ) {
    return ((_year%4==0) && (_year%100!=0)) || (_year%400==0);
}

// ------------------------------------------------------------------ 
// Desc: 
// NOTE: the input y,m,d must be int
// ------------------------------------------------------------------ 

void ex_greg2jul ( uint* _out_jul, int _year, int _month, int _day ) {
    if( !ex_is_valid_date ( _year, _month, _day ) ) {
        ex_warning ( "can't set date (%dy,%dm,%dd). the value is invalid!", _year, _month, _day );
        *_out_jul = 0;
        return;
    }

    *_out_jul = (1461*(_year+4800+(_month-14)/12))/4+(367*(_month-2-12*((_month-14)/12)))/12-(3*((_year+4900+(_month-14)/12)/100))/4+_day-32075;
}

// ------------------------------------------------------------------ 
// Desc: 
// NOTE: the input y,m,d must be int
// ------------------------------------------------------------------ 

void ex_jul2greg ( int* _out_year, int* _out_month, int* _out_day, uint _jul ) {
    register int l,n,i,j;
    l=_jul+68569;
    n=(4*l)/146097;
    l=l-(146097*n+3)/4;
    i=(4000*(l+1))/1461001;
    l=l-(1461*i)/4+31;
    j=(80*l)/2447;
    *_out_day=l-(2447*j)/80;
    l=j/11;
    *_out_month=j+2-(12*l);
    *_out_year=100*(n-49)+i+l;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_date_set ( ex_date_t* _date, uint _year, uint _month, uint _day ) {
    ex_greg2jul( &(_date->_julian), _year, _month, _day);
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_date_day ( const ex_date_t* _date ) {
    int d,m,y;
    ex_jul2greg ( _date->_julian, &y, &m, &d );
    return d;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_date_month ( const ex_date_t* _date ) {
    int d,m,y;
    ex_jul2greg ( _date->_julian, &y, &m, &d );
    return m;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_date_year ( const ex_date_t* _date ) {
    int d,m,y;
    ex_jul2greg ( _date->_julian, &y, &m, &d );
    return y;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_day_of_week ( const ex_date_t* _date ) {
    return (_date->_julian+1) % 7;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_day_of_year ( const ex_date_t* _date ) {
    int y,m,d;
    uint jd;
    ex_jul2greg ( _date->_julian, &y, &m, &d );
    ex_greg2jul ( &jd, y, 1, 1 );

    return _date->_julian-jd+1;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_days_in_month ( const ex_date_t* _date ) {
    int y,m,d;
    ex_jul2greg ( _date->_julian, &y, &m, &d );

    if( m==2 && ex_is_leap_year(y) )
        return 29;

    return __month_days[m-1];
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

bool ex_date_is_leap_year ( const ex_date_t* _date ) {
    return ex_is_leap_year( ex_date_year(_date) );
}
