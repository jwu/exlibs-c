// ======================================================================================
// File         : atomic.c
// Author       : Wu Jie 
// Last Change  : 05/12/2011 | 10:08:45 AM | Thursday,May
// Description  : 
// ======================================================================================

///////////////////////////////////////////////////////////////////////////////
// includes
///////////////////////////////////////////////////////////////////////////////

#include "exsdk.h"

///////////////////////////////////////////////////////////////////////////////
// defiens
///////////////////////////////////////////////////////////////////////////////

static ex_spin_lock_t __locks[32];

///////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static inline void __enter_lock ( void *_a ) {
    uintptr_t index = ((((uintptr_t)_a) >> 3) & 0x1f);
    ex_atomic_lock(&__locks[index]);
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static inline void __leave_lock ( void *_a ) {
    uintptr_t index = ((((uintptr_t)_a) >> 3) & 0x1f);
    ex_atomic_unlock(&__locks[index]);
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

int ex_atomic_cas_ ( ex_atomic_t *_a, int _oldval, int _newval ) {

    int retval = 0;

    __enter_lock(_a);
    if ( _a->value == _oldval ) {
        _a->value = _newval;
        retval = 1;
    }
    __leave_lock(_a);

    return retval;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

int ex_atomic_casptr_ ( void **_a, void *_oldval, void *_newval ) {

    int retval = 0;

    __enter_lock(_a);
    if ( *_a == _oldval ) {
        *_a = _newval;
        retval = 1;
    }
    __leave_lock(_a);

    return retval;
}
